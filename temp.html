<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªçc Thu·ªôc Patimokkha - Karaoke Pro</title>
    <style>
        /* --- C·∫§U H√åNH M√ÄU S·∫ÆC --- */
        :root {
            --primary-color: #8B4513;
            --bg-color: #fdfbf7;
            --text-color: #333;
            --box-bg: #e0e0e0;
            --box-border: #999;
            --footer-bg: rgba(255, 255, 255, 0.95);
            --highlight-color: #d35400;
            --karaoke-bg-active: #fffaf0;
            --karaoke-text-active: #8B4513;
        }

        [data-theme="dark"] {
            --primary-color: #d4a373;
            --bg-color: #1a1a1a;
            --text-color: #e0e0e0;
            --box-bg: #333;
            --box-border: #555;
            --footer-bg: rgba(45, 45, 45, 0.95);
            --highlight-color: #f39c12;
            --karaoke-bg-active: #2d2d2d;
            --karaoke-text-active: #f39c12;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 15px;
            padding-bottom: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container { max-width: 800px; width: 100%; }

        /* --- TOP NAV --- */
        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 15px;
        }

        .nav-controls { display: flex; gap: 5px; flex-grow: 1; justify-content: center; }

        select {
            padding: 6px; font-size: 16px; border-radius: 5px;
            border: 1px solid var(--box-border);
            background-color: var(--bg-color); color: var(--text-color);
            max-width: 200px;
        }

        .btn-nav, .btn-darkmode {
            background: transparent; border: 1px solid var(--primary-color);
            color: var(--primary-color); padding: 5px 10px; border-radius: 5px; cursor: pointer;
        }
        .btn-darkmode { background: #34495e; color: #fff; border: none; font-size: 18px; }

        h2 { text-align: center; color: var(--primary-color); margin: 5px 0 15px 0; font-size: 20px; }

        /* --- TEXT CONTENT --- */
        .text-content {
            font-size: 18px; text-align: center; line-height: 1.8; position: relative;
        }
        
        /* ·∫®n vƒÉn b·∫£n g·ªëc khi Karaoke b·∫≠t */
        .text-content.karaoke-active > .line-break { display: none; }

        /* Hi·ªán d√≤ng Karaoke */
        .text-content.karaoke-active .line-karaoke-show {
            display: block !important;
            font-size: 22px; font-weight: bold;
            color: var(--karaoke-text-active);
            background-color: var(--karaoke-bg-active);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            animation: fadeIn 0.4s;
            border: 2px solid var(--primary-color);
            margin-top: 20px;
            position: relative;
        }

        .line-karaoke-show[data-has-custom-time="true"]::after {
            content: "‚è±Ô∏è"; position: absolute; top: 5px; right: 5px; font-size: 12px; opacity: 0.5;
        }

        .word { display: inline-block; margin: 0 2px; padding: 1px 2px; }
        .word.hidden {
            color: transparent; background-color: var(--box-bg);
            border: 1px solid var(--box-border); cursor: pointer; min-width: 1.2em;
        }
        .word.revealed { color: var(--highlight-color); border-bottom: 1px dashed var(--highlight-color); }
        .line-break { display: block; margin-bottom: 8px; }

        /* --- BOTTOM BAR --- */
        .bottom-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background-color: var(--footer-bg); color: var(--text-color);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.2); z-index: 1000;
            border-top: 2px solid var(--primary-color);
            backdrop-filter: blur(5px);
        }

        .bar-main-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 8px 10px; gap: 10px; max-width: 800px; margin: 0 auto;
        }

        audio { height: 32px; flex-grow: 1; max-width: 100%; border-radius: 15px; }

        .controls-cluster { display: flex; gap: 8px; align-items: center; flex-shrink: 0; }

        .icon-btn {
            background-color: var(--primary-color); color: #fff; border: none;
            width: 36px; height: 36px; border-radius: 50%;
            font-size: 16px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.1s;
        }
        .icon-btn:active { transform: scale(0.95); }
        
        /* Tr·∫°ng th√°i n√∫t Karaoke */
        .btn-karaoke { background-color: #f39c12; transition: all 0.3s ease; }
        .btn-karaoke.active-auto { background-color: #27ae60; animation: pulse-green 2s infinite; }
        .btn-karaoke.active-manual { background-color: #f1c40f; color: #333; }
        
        /* N√∫t Exit m·ªõi */
        #btn-exit-karaoke {
            background-color: #c0392b; /* M√†u ƒë·ªè */
            display: none; /* M·∫∑c ƒë·ªãnh ·∫©n */
        }
        /* Ch·ªâ hi·ªán n√∫t Exit khi body/container c√≥ class karaoke-active */
        .karaoke-active-mode #btn-exit-karaoke { display: flex; }

        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(39, 174, 96, 0.4); }
            70% { box-shadow: 0 0 0 6px rgba(39, 174, 96, 0); }
            100% { box-shadow: 0 0 0 0 rgba(39, 174, 96, 0); }
        }
        
        .btn-settings { background-color: #7f8c8d; }
        .settings-panel {
            max-height: 0; overflow: hidden; transition: max-height 0.3s ease-in-out;
            background-color: rgba(0,0,0,0.03); border-top: 1px dashed var(--box-border);
        }
        .settings-panel.open { max-height: 200px; }
        .settings-content { padding: 10px; display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;}
        .setting-group { display: flex; align-items: center; gap: 8px; }

        /* N√∫t nh·ªè trong setting */
        .btn-sm {
            border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 13px;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        @media (max-width: 600px) {
            .bar-main-row { flex-direction: column; }
            .controls-cluster { width: 100%; justify-content: center; gap: 15px; }
        }
    </style>
</head>
<body>

<div class="container" id="main-container">
    <div class="top-nav">
        <button class="btn-darkmode" onclick="toggleTheme()">üåô</button> 
        <div class="nav-controls">
            <button class="btn-nav" onclick="changeSection(-1)">‚ùÆ</button>
            <select id="section-select" onchange="selectSection()"></select>
            <button class="btn-nav" onclick="changeSection(1)">‚ùØ</button>
        </div>
    </div>

    <h2 id="section-title">Loading...</h2>
    <div id="display-area" class="text-content"></div>
</div>

<div class="bottom-bar">
    <div class="bar-main-row">
        <audio id="audioPlayer" controls>Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ audio.</audio>

        <div class="controls-cluster">
            <button class="icon-btn" onclick="navigateKaraoke(-1)" title="L√πi">¬´</button>
            
            <button id="karaoke-toggle-btn" class="icon-btn btn-karaoke" onclick="toggleKaraokeAction()" title="Karaoke">üé§</button>
            
            <button id="btn-exit-karaoke" class="icon-btn" onclick="exitKaraoke()" title="Tho√°t Karaoke">‚úñ</button>

            <button class="icon-btn" onclick="navigateKaraoke(1)" title="T·ªõi">¬ª</button>
            <button id="settings-btn" class="icon-btn btn-settings" onclick="toggleSettings()" title="C√†i ƒë·∫∑t">‚öôÔ∏è</button>
        </div>
    </div>

    <div id="settings-panel" class="settings-panel">
        <div class="settings-content">
            <div class="setting-group">
                <span style="font-size:13px; font-weight:600">·∫®n ch·ªØ:</span>
                <input type="range" id="difficulty" min="10" max="90" value="40" oninput="updateLabel(this.value)" style="width:80px">
                <span id="difficulty-label" style="font-size:12px">40%</span>
                <button class="btn-sm" onclick="hideRandomWords()" style="background:#d35400; color:white;">·∫®n</button>
                <button class="btn-sm" onclick="resetText(true)" style="background:#7f8c8d; color:white;">Hi·ªán</button>
            </div>

            <div class="setting-group">
                <span style="font-size:13px; font-weight:600">T·ªëc ƒë·ªô:</span>
                
                <button id="btn-show-speed" class="btn-sm" onclick="toggleSpeedControl()" style="background:#2980b9; color:white;">‚Ü™Tu·ª≥ ch·ªânh</button>

                <div id="speed-control-area" style="display:none; align-items:center; gap:5px;">
                    <input type="range" id="karaoke-interval" min="1" max="10" step="0.5" value="3" oninput="updateKaraokeInterval(this.value)" style="width:80px">
                    <span id="karaoke-interval-label" style="font-size:12px">3.0s</span>
                    <button class="btn-sm" onclick="resetSpeedDefault()" style="background:#c0392b; color:white;" title="Hu·ª∑ tu·ª≥ ch·ªânh, d√πng th·ªùi gian g·ªëc">‚Ü©M·∫∑c ƒë·ªãnh</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- D·ªÆ LI·ªÜU ---
    const sections = [
        {
            id: 'pubba', title: 'Pubbakara·πáƒÅdi Vidhi', audio: 'audio.mp3', 
            text: `Sammajjanƒ´ padƒ´po ca, udaka·πÉ ƒÅsanena ca; [5.0]
Uposathassa etƒÅni, pubbakara·πáanti vuccati. [4.0]
Chanda, pƒÅrisuddhi, utukkhƒÅna·πÉ, [3.0]
bhikkhuga·πáanƒÅ ca ovƒÅdo; [3.0]
Uposathassa etƒÅni, pubbakiccanti vuccati. [4.0]`
        },
        {
            id: 'nidana', title: 'NidƒÅnuddeso', audio: 'audio.mp3',
            text: `Namo tassa Bhagavato Arahato SammƒÅsambuddhassa.[5.0]
Namo tassa Bhagavato Arahato SammƒÅsambuddhassa.[5.0]
Namo tassa Bhagavato Arahato SammƒÅsambuddhassa.[6.0]

Su·πáƒÅtu me bhante sa·πÖgho.[3.5]
Ajjuposatho pannaraso, yadi sa·πÖghassa pattakalla·πÉ, 
sa·πÖgho uposatha·πÉ kareyya, pƒÅtimokkha·πÉ uddiseyya.

Ki·πÉ sa·πÖghassa pubbakicca·πÉ? 
PƒÅrisuddhi·πÉ ƒÅyasmanto ƒÅrocetha, 
pƒÅtimokkha·πÉ uddisissƒÅmi, 
ta·πÉ sabbeva santƒÅ sƒÅdhuka·πÉ su·πáoma manasi karoma.

Yassa siyƒÅ ƒÅpatti, so ƒÅvikareyya, asantiyƒÅ ƒÅpattiyƒÅ tu·πáhƒ´ bhavitabba·πÉ, 
tu·πáhƒ´bhƒÅvena kho panƒÅyasmante ‚Äò‚ÄòparisuddhƒÅ‚Äô‚Äôti vedissƒÅmi. 
YathƒÅ kho pana paccekapu·π≠·π≠hassa veyyƒÅkara·πáa·πÉ hoti, 
evameva·πÉ evar≈´pƒÅya parisƒÅya yƒÅvatatiya·πÉ anusƒÅvita·πÉ hoti. 
Yo pana bhikkhu yƒÅvatatiya·πÉ anusƒÅviyamƒÅne saramƒÅno santi·πÉ ƒÅpatti·πÉ nƒÅvikareyya, 
sampajƒÅnamusƒÅvƒÅdassa hoti.

SampajƒÅnamusƒÅvƒÅdo kho panƒÅyasmanto antarƒÅyiko dhammo vutto bhagavatƒÅ, 
tasmƒÅ saramƒÅnena bhikkhunƒÅ ƒÅpannena visuddhƒÅpekkhena 
santƒ´ ƒÅpatti ƒÅvikƒÅtabbƒÅ, ƒÅvikatƒÅ hissa phƒÅsu hoti.

Uddi·π≠·π≠ha·πÉ kho ƒÅyasmanto nidƒÅna·πÉ.

TatthƒÅyasmante pucchƒÅmi, kaccittha parisuddhƒÅ, 
dutiyampi pucchƒÅmi, kaccittha parisuddhƒÅ, 
tatiyampi pucchƒÅmi, kaccittha parisuddhƒÅ, 
parisuddhetthƒÅyasmanto, tasmƒÅ tu·πáhƒ´, evameta·πÉ dhƒÅrayƒÅmƒ´ti.

NidƒÅnuddeso pa·π≠hamo`
        },
		{
            id: 'Pr 1', title: 'PƒÅrƒÅjika 1', audio: '1Pr-001.mp3',
 text: `Tatrime cattƒÅro pƒÅrƒÅjikƒÅ dhammƒÅ uddesa·πÉ ƒÅgacchanti.[5.0]
Yo pana bhikkhu bhikkh≈´na·πÉ sikkhƒÅsƒÅjƒ´vasamƒÅpanno sikkha·πÉ [5.0]
appaccakkhƒÅya dubbalya·πÉ anƒÅvikatvƒÅ methuna·πÉ dhamma·πÉ pa·π≠iseveyya, [5.0]
antamaso tiracchƒÅnagatƒÅyapi, pƒÅrƒÅjiko hoti asa·πÉvƒÅso.[5.0]`
        },
    ];

    // --- BI·∫æN ---
    let globalInterval = 3000; 
    let karaokeTimeout = null;
    let currentKaraokeLine = 0;
    let allLines = [];
    let currentSectionIndex = 0;
    
    // Khai b√°o c√°c ph·∫ßn t·ª≠ DOM
    const displayArea = document.getElementById('display-area');
    const titleArea = document.getElementById('section-title');
    const sectionSelect = document.getElementById('section-select');
    const audioPlayer = document.getElementById('audioPlayer');
    const karaokeToggleBtn = document.getElementById('karaoke-toggle-btn');
    const settingsPanel = document.getElementById('settings-panel');

    // --- INIT ---
    function init() {
        
        // --- 1. T·∫¢I C√ÄI ƒê·∫∂T GIAO DI·ªÜN V√Ä T·ªêC ƒê·ªò BAN ƒê·∫¶U ---
        const savedTheme = localStorage.getItem('themePreference');
        const body = document.body;
        const btn = document.querySelector('.btn-darkmode');

        if (savedTheme === 'dark') {
            body.setAttribute('data-theme', 'dark');
            if (btn) btn.innerHTML = "‚òÄÔ∏è";
        } else {
             body.removeAttribute('data-theme');
             if (btn) btn.innerHTML = "üåô";
        }
        
        const savedInterval = localStorage.getItem('overrideInterval');
        const intervalInput = document.getElementById('karaoke-interval');
        const speedControlArea = document.getElementById('speed-control-area');
        const btnShowSpeed = document.getElementById('btn-show-speed');

        if (savedInterval !== null) {
            const parsedInterval = parseFloat(savedInterval);
            globalInterval = parsedInterval * 1000; 
            intervalInput.value = parsedInterval.toFixed(1);
            document.getElementById('karaoke-interval-label').innerText = parsedInterval.toFixed(1) + "s";
            
            speedControlArea.style.display = 'flex';
            btnShowSpeed.style.display = 'none';
        } else {
            globalInterval = 3000;
            intervalInput.value = 3;
            speedControlArea.style.display = 'none';
            btnShowSpeed.style.display = 'inline-block';
        }

        // --- 2. SETUP PH·∫¶N C√íN L·∫†I ---
        sections.forEach((sec, index) => {
            let option = document.createElement("option");
            option.value = index; option.text = sec.title;
            sectionSelect.appendChild(option);
        });
        
        // --- S·ª∞ KI·ªÜN AUDIO (ƒê√É S·ª¨A) ---
        audioPlayer.addEventListener('play', () => {
            if (displayArea.classList.contains('karaoke-active') && !karaokeTimeout) runKaraokeStep();
        });
        
        // C·∫¨P NH·∫¨T M·ªöI: Ch·ªâ d·ª´ng timer n·∫øu user b·∫•m pause, kh√¥ng d·ª´ng n·∫øu audio t·ª± h·∫øt
        audioPlayer.addEventListener('pause', () => {
            if (displayArea.classList.contains('karaoke-active')) {
                // N·∫øu audio d·ª´ng v√¨ ƒë√£ h·∫øt b√†i (ended), THO√ÅT NGAY, ƒë·ªÉ timer ti·∫øp t·ª•c ch·∫°y
                if (audioPlayer.ended) return;

                // N·∫øu audio d·ª´ng do ng∆∞·ªùi d√πng b·∫•m pause
                if(karaokeTimeout) clearTimeout(karaokeTimeout); 
                karaokeTimeout = null;
                updateButtonVisuals('manual');
            }
        });

        let initialIndex = 0;
        const savedIndex = localStorage.getItem('lastSectionIndex');
        if (savedIndex !== null) {
            const parsedIndex = parseInt(savedIndex);
            if (parsedIndex >= 0 && parsedIndex < sections.length) {
                initialIndex = parsedIndex;
            }
        }
        
        loadSection(initialIndex);
    }

    // --- LOGIC GIAO DI·ªÜN & PERSISTENCE ---
    function loadSection(index) {
        exitKaraoke(); 
        if (index < 0) index = sections.length - 1;
        if (index >= sections.length) index = 0;
        currentSectionIndex = index;
        
        localStorage.setItem('lastSectionIndex', index);

        sectionSelect.value = index;
        titleArea.innerText = sections[index].title;
        audioPlayer.src = sections[index].audio;
        renderText(sections[index].text);
    }

    function selectSection() { loadSection(parseInt(sectionSelect.value)); }
    function changeSection(d) { loadSection(currentSectionIndex + d); }

    function renderText(rawText) {
        displayArea.innerHTML = '';
        allLines = [];
        const lines = rawText.split('\n').filter(line => line.trim() !== '');
        
        let cumulativeStartTimeMs = 0;
        
        const overrideIntervalMs = localStorage.getItem('overrideInterval') ? parseFloat(localStorage.getItem('overrideInterval')) * 1000 : null;

        lines.forEach(line => {
            let cleanLine = line.trim();
            let customDuration = null; 

            const timeMatch = cleanLine.match(/\s*\[(\d+(\.\d+)?)\]\s*$/);
            if (timeMatch) {
                customDuration = parseFloat(timeMatch[1]) * 1000;
                cleanLine = cleanLine.replace(timeMatch[0], '');
            }

            const lineDiv = document.createElement('div');
            lineDiv.className = 'line-break';
            
            let currentLineDuration; 

            if (overrideIntervalMs !== null) {
                currentLineDuration = overrideIntervalMs;
            } else {
                currentLineDuration = customDuration || 3000; 
            }

            lineDiv.dataset.startTime = cumulativeStartTimeMs / 1000;
            lineDiv.dataset.duration = currentLineDuration;
            
            if (overrideIntervalMs === null && customDuration) {
                lineDiv.dataset.hasCustomTime = "true";
            } else if (overrideIntervalMs !== null) {
                lineDiv.dataset.hasCustomTime = "false"; 
            }

            cumulativeStartTimeMs += currentLineDuration;

            cleanLine.split(/\s+/).forEach(wordStr => {
                if (wordStr.trim() === '') return;
                const span = document.createElement('span');
                span.className = 'word';
                span.innerText = wordStr;
                span.onclick = function() {
                    if (this.classList.contains('hidden')) {
                        this.classList.remove('hidden');
                        this.classList.add('revealed');
                    }
                };
                lineDiv.appendChild(span);
            });
            displayArea.appendChild(lineDiv);
            allLines.push(lineDiv);
        });
    }

    function updateButtonVisuals(state) {
        karaokeToggleBtn.classList.remove('active-auto', 'active-manual');
        if (state === 'auto') {
            karaokeToggleBtn.classList.add('active-auto'); karaokeToggleBtn.innerHTML = "‚ùö‚ùö";
        } else if (state === 'manual') {
            karaokeToggleBtn.classList.add('active-manual'); karaokeToggleBtn.innerHTML = "‚ñ∂";
        } else {
            karaokeToggleBtn.innerHTML = "üé§";
        }
    }

    // --- LOGIC KARAOKE (ƒê√É S·ª¨A) ---
    
    function toggleKaraokeAction() {
        const isActive = displayArea.classList.contains('karaoke-active');
        const isRunning = !!karaokeTimeout;

        if (!isActive) {
            startKaraokeMode();
        } else {
            // N√∫t n√†y b√¢y gi·ªù th√¥ng minh h∆°n:
            // 1. N·∫øu ƒëang ch·∫°y (isRunning) HO·∫∂C audio ƒëang ph√°t -> B·∫•m v√†o ƒë·ªÉ PAUSE
            if (isRunning || !audioPlayer.paused) {
                if (!audioPlayer.paused) audioPlayer.pause();
                
                // C·∫ßn clear tay ·ªü ƒë√¢y v√¨ n·∫øu audio ƒë√£ ended th√¨ s·ª± ki·ªán pause ·ªü tr√™n s·∫Ω b·ªè qua l·ªánh clear
                if(karaokeTimeout) {
                    clearTimeout(karaokeTimeout);
                    karaokeTimeout = null;
                }
                updateButtonVisuals('manual');
            } 
            // 2. N·∫øu ƒëang d·ª´ng -> B·∫•m v√†o ƒë·ªÉ PLAY
            else {
                if (audioPlayer.ended) {
                    // N·∫øu nh·∫°c h·∫øt r·ªìi th√¨ ch·ªâ ch·∫°y ch·ªØ
                    runKaraokeStep();
                } else {
                    // N·∫øu nh·∫°c ch∆∞a h·∫øt th√¨ play nh·∫°c (nh·∫°c play s·∫Ω k√≠ch ho·∫°t ch·ªØ)
                    audioPlayer.play();
                }
            }
        }
    }

    function startKaraokeMode() {
        resetText();
        displayArea.classList.add('karaoke-active');
        document.body.classList.add('karaoke-active-mode');
        
        currentKaraokeLine = 0;
        showKaraokeLine(0);
        updateButtonVisuals('manual');
    }

    function exitKaraoke() {
        if(karaokeTimeout) clearTimeout(karaokeTimeout); karaokeTimeout = null;
        if(!audioPlayer.paused) audioPlayer.pause();

        displayArea.classList.remove('karaoke-active');
        document.body.classList.remove('karaoke-active-mode');
        document.querySelector('.line-karaoke-show')?.classList.remove('line-karaoke-show');
        updateButtonVisuals('inactive');
    }

    function runKaraokeStep() {
        if (karaokeTimeout) clearTimeout(karaokeTimeout);
        if (currentKaraokeLine >= allLines.length) { exitKaraoke(); return; }

        showKaraokeLine(currentKaraokeLine);
        updateButtonVisuals('auto'); 

        const el = allLines[currentKaraokeLine];
        const dur = parseFloat(el.dataset.duration); 

        const nextIdx = currentKaraokeLine + 1;
        if (nextIdx < allLines.length) {
            karaokeTimeout = setTimeout(() => {
                currentKaraokeLine = nextIdx; runKaraokeStep();
            }, dur);
        } else {
             karaokeTimeout = setTimeout(() => { exitKaraoke(); }, dur);
        }
    }

    function showKaraokeLine(idx) {
        document.querySelector('.line-karaoke-show')?.classList.remove('line-karaoke-show');
        if (allLines[idx]) {
            allLines[idx].classList.add('line-karaoke-show');
            allLines[idx].scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    function navigateKaraoke(d) {
        if (!audioPlayer.paused) audioPlayer.pause();
        
        if (karaokeTimeout) { clearTimeout(karaokeTimeout); karaokeTimeout = null; }
        
        if (!displayArea.classList.contains('karaoke-active')) { 
            startKaraokeMode();
        }
        
        currentKaraokeLine += d;
        if (currentKaraokeLine < 0) currentKaraokeLine = 0;
        if (currentKaraokeLine >= allLines.length) currentKaraokeLine = allLines.length - 1;

        showKaraokeLine(currentKaraokeLine);

        const targetEl = allLines[currentKaraokeLine];
        const startTimeSeconds = parseFloat(targetEl.dataset.startTime || 0);
        
        audioPlayer.currentTime = startTimeSeconds; 
        
        updateButtonVisuals('manual');
    }

    // --- C√ÅC H√ÄM PH·ª§ ---
    function hideRandomWords() {
        const wasActive = displayArea.classList.contains('karaoke-active');
        resetText(true);
        const words = document.querySelectorAll('.word');
        const count = Math.floor(words.length * (document.getElementById('difficulty').value / 100));
        Array.from({length: words.length}, (_, i) => i).sort(() => Math.random()-.5).slice(0, count).forEach(i => words[i].classList.add('hidden'));
        
        if (wasActive) {
            displayArea.classList.add('karaoke-active');
            updateButtonVisuals('manual');
        }
    }
    
    function resetText(keep = false) {
        if (!keep) exitKaraoke();
        document.querySelectorAll('.word').forEach(w => w.classList.remove('hidden', 'revealed'));
    }

    function toggleSettings() { settingsPanel.classList.toggle('open'); }
    function updateLabel(v) { document.getElementById('difficulty-label').innerText = v + "%"; }
    
    // --- C√ÅC H√ÄM M·ªöI CHO T·ªêC ƒê·ªò ---

    function toggleSpeedControl() {
        document.getElementById('btn-show-speed').style.display = 'none';
        document.getElementById('speed-control-area').style.display = 'flex';
    }

    function updateKaraokeInterval(v) { 
        const newIntervalSeconds = parseFloat(v);
        localStorage.setItem('overrideInterval', newIntervalSeconds.toFixed(1)); 
        
        document.getElementById('karaoke-interval-label').innerText = newIntervalSeconds.toFixed(1) + "s";
        loadSection(currentSectionIndex); 
        if(!audioPlayer.paused && displayArea.classList.contains('karaoke-active')) audioPlayer.pause();
    }

    function resetSpeedDefault() {
        localStorage.removeItem('overrideInterval');
        document.getElementById('karaoke-interval').value = 3;
        document.getElementById('karaoke-interval-label').innerText = "3.0s";
        document.getElementById('speed-control-area').style.display = 'none';
        document.getElementById('btn-show-speed').style.display = 'inline-block';
        loadSection(currentSectionIndex);
    }
    
    function toggleTheme() {
        const body = document.body;
        const btn = document.querySelector('.btn-darkmode');
        const isDark = body.getAttribute('data-theme') === 'dark';

        if (isDark) {
            body.removeAttribute('data-theme');
            btn.innerHTML = "üåô";
            localStorage.setItem('themePreference', 'light');
        } else {
            body.setAttribute('data-theme', 'dark');
            btn.innerHTML = "‚òÄÔ∏è";
            localStorage.setItem('themePreference', 'dark');
        }
    }

    init();
</script>
</body>
</html>